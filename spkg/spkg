#!/bin/bash

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

print_help() {
    echo "spkg - CH552 SDK CLI Tool"
    echo ""
    echo "Uso:"
    echo "  spkg -p <ruta> [comando]    Ejecuta make <comando> en la ruta"
    echo "  spkg compose                Ejecuta docker compose build"
    echo "  spkg --version              Muestra la versi√≥n"
    echo "  spkg --help                 Muestra esta ayuda"
    echo ""
    echo "Comandos make disponibles:"
    echo "  all      -> Compila y construye todo"
    echo "  bin      -> Genera binario"
    echo "  hex      -> Genera archivo HEX"
    echo "  clean    -> Limpia los archivos generados"
    echo ""
    echo "Ejemplos:"
    echo "  spkg -p ./template"
    echo "  spkg -p ./examples/Blink/ clean"
}

if [[ "$1" == "--version" ]]; then
    echo "spkg version $VERSION"
    exit 0
fi

if [[ "$1" == "--help" ]]; then
    print_help
    exit 0
fi
if [[ "$1" == "init" && -n "$2" ]]; then
    DEST_DIR="$2"
    TEMPLATE_DIR="$SCRIPT_DIR/template_project"

    if [ -d "$DEST_DIR" ]; then
        echo "‚ùå El directorio '$DEST_DIR' ya existe."
        exit 1
    fi

    echo "üß± Creando nuevo proyecto en '$DEST_DIR'..."
    cp -r "$TEMPLATE_DIR" "$DEST_DIR"

    echo "‚úÖ Proyecto base creado. Puedes compilarlo con:"
    echo "   spkg -p $DEST_DIR"
    exit 0
fi

if [[ "$1" == "compose" ]]; then
    echo "üîß Construyendo imagen con Docker Compose..."
    docker compose -f "$SCRIPT_DIR/docker-compose.yml" build
    exit $?
fi

if [[ "$1" == "-p" && -n "$2" ]]; then
    PROJECT_DIR="$2"
    MAKE_CMD="${3:-bin}"  # Por defecto 'bin'
    FULL_PATH="$(realpath "$PROJECT_DIR")"

    if [ ! -f "$FULL_PATH/Makefile" ]; then
        echo "‚ùå No se encontr√≥ un Makefile en $FULL_PATH"
        exit 1
    fi

    echo "üöÄ Ejecutando make $MAKE_CMD en: $FULL_PATH"
    docker compose -f "$SCRIPT_DIR/docker-compose.yml" run --rm \
        -v "$FULL_PATH":/project -w /project ch552_compiler make $MAKE_CMD

    # Verifica si se gener√≥ el bin solo si se us√≥ make bin o all
    if [[ "$MAKE_CMD" == "bin" || "$MAKE_CMD" == "all" ]]; then
        if [ -f "$FULL_PATH/build/main.bin" ]; then
            echo "‚úÖ Compilaci√≥n exitosa: $FULL_PATH/build/main.bin generado."
        else
            echo "‚ùå Error durante la compilaci√≥n."
        fi
    fi
    exit 0
fi

print_help
exit 1
